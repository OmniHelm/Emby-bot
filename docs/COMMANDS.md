# EmbyBot 命令文档

本文档详细列出 EmbyBot 所有可用命令，按权限等级分类，包含用法示例和功能说明。

---

## 命令前缀

支持以下前缀触发命令：`/`、`!`、`.`、`，`、`。`

---

## 用户命令

普通用户可使用的命令。

### 基础命令

| 命令 | 说明 | 使用场景 |
|------|------|----------|
| `/start` | 开启用户面板 | 私聊 |
| `/myinfo` | 查看个人状态信息 | 群组/私聊 |
| `/count` | 查看媒体库数量 | 群组/私聊 |
| `/help` | 查看帮助信息 | 群组/私聊 |
| `/faq` | 查看常见问题解答 | 群组/私聊 |
| `/guide` | 查看使用指南 | 群组/私聊 |

### 互动命令

| 命令 | 说明 | 用法 |
|------|------|------|
| `/red` | 发红包 | `/red [金额] [份数]` 或 `/red [金额] [份数] equal`（均分）|
| `/srank` | 查看红包计分排行榜 | `/srank` |

### 用户面板功能（通过 `/start` 进入）

**📺 账户功能：**
- **🎨 创建账户** - 使用积分创建 Emby 账户，输入格式：`用户名 安全码`（安全码4-6位数字）
- **🌐 服务器** - 查看服务器线路、密码和在线人数
- **🔑 重置密码** - 重新生成 Emby 登录密码
- **🗑️ 删除账号** - 永久删除自己的 Emby 账户（不可恢复）

**👤 绑定功能：**
- **⚖️ 换绑TG** - 将其他 TG 账户的 Emby 绑定到当前账户（需安全码验证）
- **🔗 绑定TG** - 绑定已存在但未关联 TG 的 Emby 账户（需密码验证）

**🎬 媒体功能：**
- **💖 我的收藏** - 查看已收藏的影片列表
- **💠 我的设备** - 查看和管理登录设备
- **🎬 显示/隐藏媒体库** - 自定义可见的媒体库
- **📽️ 求片** - 提交影片请求给管理员

**💰 兑换功能：**
- **🏪 兑换商店** - 使用积分兑换续期天数
- **🎟️ 使用兑换码** - 输入注册码或续期码

**🔍 内联搜索：**
在任意聊天框输入 `@机器人用户名 关键词` 可搜索媒体库并收藏

---

## 管理员命令

管理员（admins）可使用的命令。

### 用户管理

#### `/kk` - 综合用户管理面板
```
用法：/kk [tg_id] 或回复某人 /kk
功能：
  - 查看用户详细信息（TG ID、Emby 用户名、等级、到期时间等）
  - 封禁/解封用户
  - 赠送注册资格
  - 删除用户账户
  - 开启/关闭额外媒体库
  - 踢出群组
```

#### `/renew` - 调整用户到期时间
```
用法：
  /renew [用户名] [+/-天数]    # 指定用户名
  /renew [天数]               # 回复用户消息

示例：
  /renew 张三 +30    # 延长30天
  /renew 张三 -10    # 减少10天

说明：
  - 支持正负数调整
  - 过期账户续期后自动解封
  - 非 TG 绑定用户（emby2 表）同样支持
```

#### `/rmemby` - 删除用户
```
用法：
  /rmemby [tg_id]      # 指定 TG ID
  /rmemby [用户名]     # 指定 Emby 用户名
  /rmemby              # 回复用户消息

功能：
  - 删除 Emby 服务器账户
  - 清空数据库记录
  - 支持 TG 绑定和非 TG 绑定用户
```

#### `/score` - 加减用户积分
```
用法：回复用户消息 /score [+/-数值]
示例：
  /score +100    # 增加100积分
  /score -50     # 减少50积分
```

#### `/coins` - 加减用户币币
```
用法：回复用户消息 /coins [+/-数值]
示例：
  /coins +500    # 增加500币币
  /coins -200    # 减少200币币
```

#### `/prouser` - 添加白名单用户
```
用法：/prouser [tg_id] 或回复 /prouser
功能：
  - 将用户等级提升为 'a'（白名单）
  - 白名单用户永不过期
  - 可访问白名单专属线路
```

#### `/revuser` - 移除白名单用户
```
用法：/revuser [tg_id] 或回复 /revuser
功能：将用户从白名单降级为普通用户 'b'
```

---

### 非 TG 用户管理

#### `/ucr` - 创建非 TG 绑定用户 ⭐ 多服务器
```
用法：/ucr [用户名] [天数] [服务器ID]
示例：
  /ucr testuser 30 main     # 在主服务器创建
  /ucr testuser 30 anime    # 在动漫服务器创建

说明：
  - 必须指定服务器 ID
  - 创建后存入 emby2 表
  - 返回用户名、密码和访问线路
```

#### `/uinfo` - 查询用户信息
```
用法：/uinfo [用户名]
功能：
  - 查询用户 Emby ID
  - 显示创建时间、到期时间
  - 显示所属服务器
```

#### `/urm` - 删除指定用户名
```
用法：/urm [用户名]
功能：遍历所有服务器删除指定用户名的账户
```

#### `/userip` - 查询用户设备和 IP
```
用法：/userip [用户名]
功能：
  - 显示用户使用过的所有设备
  - 显示登录 IP 地址
  - 显示最后活动时间
```

#### `/udeviceid` - 查询设备 ID
```
用法：/udeviceid [用户名]
功能：显示用户所有设备的详细 ID 信息
```

---

### 审计命令

#### `/auditip` - IP 地址审计
```
用法：/auditip [IP地址] [天数]
示例：
  /auditip 192.168.1.100        # 查询该 IP 全部活动
  /auditip 192.168.1.100 7      # 查询最近7天活动

功能：
  - 查找使用指定 IP 的所有用户
  - 显示设备信息和活动统计
  - 检测账号共享行为
  - 风险等级评估（低/中/高）
  - 聚合所有服务器数据
```

#### `/auditdevice` - 设备名审计
```
用法：/auditdevice [设备关键词] [天数]
示例：
  /auditdevice iPhone 30        # 查询30天内iPhone设备活动

功能：
  - 按设备名模糊匹配
  - 显示使用该设备的所有用户
  - 检测异常设备使用
```

#### `/auditclient` - 客户端审计
```
用法：/auditclient [客户端关键词] [天数]
示例：
  /auditclient Infuse 7         # 查询7天内Infuse客户端活动

功能：
  - 按客户端名称匹配
  - 统计客户端使用情况
  - 检测可疑客户端
```

---

### 同步与清理

#### `/syncgroupm` - 同步群组成员 ⚠️ 危险
```
用法：/syncgroupm true
功能：
  - 检测不在群内的 Emby 用户
  - 自动删除这些用户的 Emby 账户
  - 清空数据库记录
注意：操作不可逆，请谨慎使用
```

#### `/syncunbound` - 同步未绑定用户 ⚠️ 危险
```
用法：/syncunbound true
功能：
  - 检测 Emby 中未绑定 Bot 的账户
  - 自动删除这些孤立账户
  - 聚合所有服务器
```

#### `/scan_embyname` - 扫描同名记录
```
用法：/scan_embyname
功能：
  - 检测数据库中同名的用户记录
  - 帮助清理重复数据
```

#### `/deleted` - 清理死号 ⚠️ 危险
```
用法：/deleted true
功能：
  - 检测已注销 TG 账户的用户
  - 删除其 Emby 账户和数据库记录
```

#### `/kick_not_emby` - 踢出无号用户
```
用法：/kick_not_emby true（群组内使用）
功能：
  - 检测群内没有 Emby 账户的用户
  - 自动踢出这些用户
```

#### `/only_rm_emby` - 仅删除 Emby 账号
```
用法：/only_rm_emby [用户名]
功能：
  - 只删除 Emby 服务器账户
  - 保留数据库记录
  - 遍历所有服务器查找
```

#### `/only_rm_record` - 仅删除数据库记录
```
用法：/only_rm_record [tg_id]
功能：
  - 只删除数据库记录
  - 不删除 Emby 服务器账户
```

---

### 批量操作

#### `/renewall` - 批量派送天数 ⚠️ 危险
```
用法：/renewall [天数] true
示例：/renewall 30 true
功能：
  - 给所有未封禁用户（等级 b）延长天数
  - 支持正负数
```

#### `/coinsall` - 批量派送币币 ⚠️ 危险
```
用法：/coinsall [数量] [等级] true
示例：
  /coinsall 100 b true    # 给所有普通用户发100币
  /coinsall 200 a true    # 给所有白名单用户发200币

等级说明：
  a = 白名单用户
  b = 普通用户
  c = 封禁用户
```

#### `/coinsclear` - 清空所有币币 ⚠️ 危险
```
用法：/coinsclear true
功能：将所有用户的币币清零
```

#### `/callall` - 群发消息
```
用法：/callall（私聊使用）
功能：
  - 向所有用户私发消息
  - 支持发送文本、图片
  - 自动处理限速
```

---

### 定时任务手动触发

#### `/check_ex` - 到期检测
```
用法：/check_ex true
功能：
  - 检测所有到期用户
  - 自动续期（如有足够积分/币币）
  - 禁用无法续期的账户
  - 删除过期超过封存天数的账户
```

#### `/low_activity` - 活跃度检测
```
用法：/low_activity true
功能：
  - 检测长期不活跃用户
  - 自动禁用不活跃账户
  - 默认检测天数由配置决定
```

#### `/days_ranks` - 播放日榜
```
用法：/days_ranks
功能：
  - 生成当日播放排行榜海报
  - 统计电影/剧集播放次数
  - 聚合所有服务器数据
```

#### `/week_ranks` - 播放周榜
```
用法：/week_ranks
功能：
  - 生成本周播放排行榜海报
  - 统计7天内播放数据
```

#### `/uranks` - 观影时长榜
```
用法：/uranks [天数]
示例：/uranks 7
功能：
  - 生成用户观影时长排行
  - 手动触发不结算币币奖励
  - 定时任务会自动结算奖励
```

#### `/sync_favorites` - 同步收藏记录
```
用法：/sync_favorites
功能：
  - 从 Emby 同步所有用户的收藏
  - 更新本地收藏数据库
```

---

### 服务器管理

#### `/servers` - 查看服务器列表
```
用法：/servers（私聊）
功能：
  - 显示所有已配置的服务器
  - 显示服务器状态、用户数
  - 显示访问线路
```

#### `/servercheck` - 健康检查
```
用法：/servercheck（私聊）
功能：
  - 检测所有服务器连通性
  - 显示响应时间
  - 报告异常服务器
```

#### `/embyadmin` - 开启 Emby 管理权限
```
用法：/embyadmin [tg_id] 或回复 /embyadmin
功能：
  - 开启用户的 Emby 控制台权限
  - 用户可访问 Emby 后台
```

---

### 皮套人管理

#### `/white_channel` - 添加频道白名单
```
用法：/white_channel [频道ID]
功能：允许指定频道身份发言
```

#### `/rev_white_channel` - 移除频道白名单
```
用法：/rev_white_channel [频道ID]
```

#### `/unban_channel` - 解封皮套人
```
用法：/unban_channel [频道ID]
```

---

### 求片管理

#### `/viewrequests` - 查看求片列表
```
用法：/viewrequests [页码]
功能：分页显示所有求片请求
```

#### `/exportrequests` - 导出求片
```
用法：/exportrequests
功能：导出所有求片请求为文件
```

---

### 系统管理

#### `/restart` - 重启 Bot
```
用法：/restart
功能：
  - 保存当前状态
  - 退出进程
  - 依赖 Docker restart: always 自动重启
```

#### `/update_bot` - 更新 Bot
```
用法：/update_bot
功能：
  - 从 GitHub 拉取最新代码
  - 自动安装依赖
  - 重启 Bot
```

#### `/config` - 高级配置面板
```
用法：/config
功能：
  - 修改 Bot 运行配置
  - 开关定时任务
  - 调整各项参数
```

---

## Owner 专属命令

仅 Bot 所有者可使用的命令。

### 管理员管理

#### `/proadmin` - 添加 Bot 管理员
```
用法：/proadmin [tg_id]
```

#### `/revadmin` - 移除 Bot 管理员
```
用法：/revadmin [tg_id]
```

---

### 数据库操作

#### `/backup_db` - 手动备份数据库
```
用法：/backup_db
功能：
  - 执行 mysqldump 备份
  - 保存到配置的备份目录
  - 自动清理超过限制数量的旧备份
```

#### `/bindall_id` - 批量更新 EmbyID ⚠️ 危险
```
用法：/bindall_id true
功能：
  - 遍历所有用户
  - 根据用户名从 Emby 获取最新 ID
  - 更新数据库记录
```

#### `/restore_from_db` - 恢复 Emby 账户 ⚠️ 危险
```
用法：/restore_from_db true
功能：
  - 从数据库记录恢复 Emby 账户
  - 用于服务器重装后恢复用户
  - 自动跳过已存在的账户
```

---

### 批量封禁/解封

#### `/unbanall` - 解封所有用户 ⚠️ 危险
```
用法：/unbanall true
功能：
  - 解除所有用户的禁用状态
  - 恢复 Emby 播放权限
  - 更新数据库等级为 'b'
```

#### `/banall` - 禁用所有用户 ⚠️ 危险
```
用法：/banall true
功能：
  - 禁用所有用户的 Emby 账户
  - 更新数据库等级为 'c'
  - 白名单用户除外
```

---

### 媒体库批量管理

#### `/embylibs_blockall` - 关闭所有媒体库 ⚠️ 危险
```
用法：/embylibs_blockall true
功能：隐藏所有用户的所有媒体库
```

#### `/embylibs_unblockall` - 开启所有媒体库 ⚠️ 危险
```
用法：/embylibs_unblockall true
功能：显示所有用户的所有媒体库
```

#### `/extraembylibs_blockall` - 关闭额外媒体库 ⚠️ 危险
```
用法：/extraembylibs_blockall true
功能：隐藏配置中指定的额外媒体库
```

#### `/extraembylibs_unblockall` - 开启额外媒体库 ⚠️ 危险
```
用法：/extraembylibs_unblockall true
功能：显示配置中指定的额外媒体库
```

---

### 危险操作

#### `/paolu` - 跑路模式 ☠️ 极度危险
```
用法：/paolu true
功能：
  - 删除所有 Emby 用户账户
  - 清空所有数据库记录
  - 此操作不可逆！！！
```

---

## 命令确认机制

以下危险命令需要添加 `true` 参数确认执行：

| 命令 | 风险等级 |
|------|----------|
| `/deleted true` | ⚠️ 中 |
| `/syncgroupm true` | ⚠️ 中 |
| `/syncunbound true` | ⚠️ 中 |
| `/coinsclear true` | ⚠️ 中 |
| `/kick_not_emby true` | ⚠️ 中 |
| `/renewall [天数] true` | ⚠️ 中 |
| `/coinsall [数量] [等级] true` | ⚠️ 中 |
| `/check_ex true` | 🟢 低 |
| `/low_activity true` | 🟢 低 |
| `/unbanall true` | 🔴 高 |
| `/banall true` | 🔴 高 |
| `/bindall_id true` | 🔴 高 |
| `/restore_from_db true` | 🔴 高 |
| `/embylibs_blockall true` | 🔴 高 |
| `/embylibs_unblockall true` | 🔴 高 |
| `/paolu true` | ☠️ 极高 |

---

## 权限等级说明

| 等级 | 标识 | 说明 | 命令范围 |
|------|------|------|----------|
| 用户 | `user_p` | 普通群成员 | 基础命令 |
| 管理员 | `admin_p` | `admins` 列表中的用户 | 用户管理、审计、同步等 |
| Owner | `owner_p` | `owner` 指定的用户 | 所有命令 |

---

## 用户等级说明

| 等级 | 代码 | 说明 | 特权 |
|------|------|------|------|
| 白名单 | `a` | VIP 用户 | 永不过期，专属线路 |
| 正常 | `b` | 普通用户 | 有到期时间 |
| 临时/禁用 | `c` | 已封禁用户 | 无法播放，可续期解封 |
| 未注册 | `d` | 无账户 | 需创建账户 |

---

## 多服务器相关命令

### 创建用户时指定服务器
```bash
/ucr 用户名 30 main      # 在 main 服务器创建
/ucr 用户名 30 anime     # 在 anime 服务器创建
/ucr 用户名 30 movie     # 在 movie 服务器创建
```

### 查看服务器状态
```bash
/servers                  # 查看所有服务器列表
/servercheck              # 执行健康检查
```

### 多服务器适配说明

以下命令会自动聚合所有服务器数据：
- `/auditip` - 从所有服务器查询 IP 活动
- `/auditdevice` - 从所有服务器查询设备活动
- `/auditclient` - 从所有服务器查询客户端活动
- `/syncunbound` - 检查所有服务器的未绑定账户
- `/days_ranks` / `/week_ranks` - 聚合所有服务器播放数据
- `/uranks` - 聚合所有服务器观影时长

以下命令会根据用户所属服务器自动定位：
- `/renew` - 操作用户所在服务器
- `/rmemby` - 删除用户所在服务器账户
- `/kk` 面板操作 - 自动定位用户服务器

---

## 定时任务说明

| 任务 | 触发时间 | 功能 | 手动触发 |
|------|----------|------|----------|
| 到期检测 | 可配置 | 自动续期/禁用/删除 | `/check_ex true` |
| 活跃检测 | 可配置 | 禁用不活跃用户 | `/low_activity true` |
| 日榜推送 | 每日 | 生成播放日榜 | `/days_ranks` |
| 周榜推送 | 每周 | 生成播放周榜 | `/week_ranks` |
| 观影榜 | 可配置 | 时长排行+奖励 | `/uranks [天数]` |
| 数据库备份 | 可配置 | 自动备份 | `/backup_db` |
| 自动更新 | 12:30 | 检查代码更新 | `/update_bot` |

---

*文档版本: 2.0*
*更新时间: 2025-11-25*
