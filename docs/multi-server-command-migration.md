# å¤šæœåŠ¡å™¨æ¶æ„ä¸‹çš„å‘½ä»¤äº¤äº’è®¾è®¡ä¸ä¿®æ”¹éœ€æ±‚

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0
**åˆ›å»ºæ—¥æœŸ**: 2024-11-24
**æ›´æ–°æ—¥æœŸ**: 2025-11-25
**çŠ¶æ€**: âœ… è¿ç§»å®Œæˆ

---

## ğŸ“‹ ç›®å½•

1. [æ ¸å¿ƒé—®é¢˜](#æ ¸å¿ƒé—®é¢˜)
2. [äº¤äº’è®¾è®¡æ–¹æ¡ˆ](#äº¤äº’è®¾è®¡æ–¹æ¡ˆ)
3. [å‘½ä»¤åˆ†ç±»ä¸å½±å“åˆ†æ](#å‘½ä»¤åˆ†ç±»ä¸å½±å“åˆ†æ)
4. [éœ€è¦ä¿®æ”¹çš„å‘½ä»¤æ¸…å•](#éœ€è¦ä¿®æ”¹çš„å‘½ä»¤æ¸…å•)
5. [å®æ–½å»ºè®®](#å®æ–½å»ºè®®)
6. [æµ‹è¯•æ£€æŸ¥æ¸…å•](#æµ‹è¯•æ£€æŸ¥æ¸…å•)

---

## æ ¸å¿ƒé—®é¢˜

### é—®é¢˜æè¿°

åœ¨å¤šæœåŠ¡å™¨æ¶æ„ä¸‹ï¼ˆåŠ¨æ¼«æœã€ç”µå½±æœã€å‰§é›†æœç­‰ï¼‰ï¼ŒTG Bot ä¸ç”¨æˆ·çš„äº¤äº’å‘½ä»¤éœ€è¦é€‚é…æ–°çš„æ¶æ„è®¾è®¡ï¼š

1. **ç”¨æˆ·åˆ›å»ºå‘½ä»¤** - éœ€è¦æŒ‡å®šç›®æ ‡æœåŠ¡å™¨
2. **ç”¨æˆ·æŸ¥è¯¢å‘½ä»¤** - éœ€è¦æ ¹æ®ç”¨æˆ·æ‰€å±æœåŠ¡å™¨æŸ¥è¯¢
3. **ç”¨æˆ·ç®¡ç†å‘½ä»¤** - éœ€è¦æ“ä½œç”¨æˆ·æ‰€å±çš„ç‰¹å®šæœåŠ¡å™¨
4. **æ‰¹é‡æ“ä½œå‘½ä»¤** - éœ€è¦è·¨æœåŠ¡å™¨æ‰¹é‡æ‰§è¡Œ

### è®¾è®¡åŸåˆ™

- âœ… **é€æ˜æ€§**: æ™®é€šç”¨æˆ·æ— éœ€å…³å¿ƒæœåŠ¡å™¨ç»†èŠ‚ï¼Œä½“éªŒæ— ç¼
- âœ… **æ˜ç¡®æ€§**: ç®¡ç†å‘˜åˆ›å»ºç”¨æˆ·æ—¶æ˜ç¡®æŒ‡å®šæœåŠ¡å™¨
- âœ… **ä¸€è‡´æ€§**: ç”¨æˆ·å§‹ç»ˆåœ¨åŒä¸€æœåŠ¡å™¨ä¸Šæ“ä½œ
- âœ… **å¯æ‰©å±•æ€§**: æ”¯æŒåç»­æ–°å¢æœåŠ¡å™¨

---

## äº¤äº’è®¾è®¡æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šæ‰‹åŠ¨æŒ‡å®šæœåŠ¡å™¨ï¼ˆå·²é‡‡ç”¨ï¼‰

**é€‚ç”¨åœºæ™¯**: å†…å®¹åˆ†ç±»ç®¡ç†ï¼ˆåŠ¨æ¼«æœã€ç”µå½±æœã€å‰§é›†æœï¼‰

**ç‰¹ç‚¹**:
- ç®¡ç†å‘˜åˆ›å»ºç”¨æˆ·æ—¶æ‰‹åŠ¨æŒ‡å®šæœåŠ¡å™¨ ID
- ç”¨æˆ·ç»‘å®šåˆ°ç‰¹å®šæœåŠ¡å™¨ï¼Œåç»­æ“ä½œè‡ªåŠ¨å®šä½
- ç”¨æˆ·æ— éœ€çŸ¥é“æœåŠ¡å™¨æ¦‚å¿µï¼Œé€æ˜ä½“éªŒ

**ç¤ºä¾‹**:
```bash
# ç®¡ç†å‘˜å‘½ä»¤ï¼ˆéœ€æŒ‡å®šæœåŠ¡å™¨ï¼‰
/ucr testuser 30 anime        # åœ¨åŠ¨æ¼«æœåˆ›å»ºç”¨æˆ·
/ucr moviefan 30 movie        # åœ¨ç”µå½±æœåˆ›å»ºç”¨æˆ·

# ç”¨æˆ·å‘½ä»¤ï¼ˆæ— éœ€æŒ‡å®šæœåŠ¡å™¨ï¼Œè‡ªåŠ¨å®šä½ï¼‰
/myinfo                       # æŸ¥çœ‹ä¸ªäººä¿¡æ¯ï¼ˆè‡ªåŠ¨è·å–æ‰€å±æœåŠ¡å™¨ï¼‰
/start                        # å¯åŠ¨é¢æ¿ï¼ˆè‡ªåŠ¨è·å–æ‰€å±æœåŠ¡å™¨ï¼‰
```

---

## å‘½ä»¤åˆ†ç±»ä¸å½±å“åˆ†æ

### åˆ†ç±»æ ‡å‡†

æ ¹æ®å‘½ä»¤çš„æœåŠ¡å™¨ä¾èµ–ç¨‹åº¦ï¼Œåˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼š

| åˆ†ç±» | è¯´æ˜ | éœ€è¦ä¿®æ”¹ | ä¿®æ”¹æ–¹å¼ |
|------|------|----------|----------|
| **A ç±»** | ç›´æ¥æ“ä½œ Emby æœåŠ¡å™¨çš„å‘½ä»¤ | âœ… æ˜¯ | ä½¿ç”¨ `get_user_emby_service()` æˆ– `get_server_by_id_or_none()` |
| **B ç±»** | æŸ¥è¯¢ç”¨æˆ·æ•°æ®çš„å‘½ä»¤ | âš ï¸ å¯èƒ½ | ç¡®ä¿æ­£ç¡®å¤„ç† `server_id` å­—æ®µ |
| **C ç±»** | æ‰¹é‡æ“ä½œå‘½ä»¤ | âœ… æ˜¯ | éå†æ‰€æœ‰æœåŠ¡å™¨æˆ–æŒ‡å®šæœåŠ¡å™¨ |
| **D ç±»** | ä¸æ¶‰åŠ Emby çš„å‘½ä»¤ | âŒ å¦ | æ— éœ€ä¿®æ”¹ |

---

## éœ€è¦ä¿®æ”¹çš„å‘½ä»¤æ¸…å•

### âœ… å·²å®Œæˆä¿®æ”¹

| å‘½ä»¤ | æ–‡ä»¶ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|------|
| `/ucr` | `bot/modules/extra/create.py` | âœ… å·²å®Œæˆ | åˆ›å»ºç”¨æˆ·æ—¶å¿…é¡»æŒ‡å®šæœåŠ¡å™¨ ID |
| `/kk` | `bot/modules/panel/kk.py` | âœ… å·²å®Œæˆ | ä½¿ç”¨ `get_user_emby_service()` |
| `/user_devices` | `bot/modules/commands/view_user.py` | âœ… å·²å®Œæˆ | æ±‡æ€»æ‰€æœ‰æœåŠ¡å™¨æ•°æ® |
| `/uinfo` | `bot/modules/extra/create.py` | âœ… å·²å®Œæˆ | ä½¿ç”¨ `get_user_emby_service()` |
| `/userip` | `bot/modules/extra/create.py` | âœ… å·²å®Œæˆ | ä½¿ç”¨ `get_user_emby_service()` |
| `/udeviceid` | `bot/modules/extra/create.py` | âœ… å·²å®Œæˆ | ä½¿ç”¨ `get_user_emby_service()` |
| ç»­æœŸå‘½ä»¤ | `bot/modules/commands/exchange.py` | âœ… å·²å®Œæˆ | ä½¿ç”¨ `get_user_emby_service()` |
| `/rmemby` | `bot/modules/commands/rmemby.py` | âœ… å·²å®Œæˆ | ä½¿ç”¨ `get_user_emby_service()` |
| `/only_rm_emby` | `bot/modules/commands/rmemby.py` | âœ… å·²å®Œæˆ | éå†æ‰€æœ‰æœåŠ¡å™¨æŸ¥æ‰¾å¹¶åˆ é™¤ |
| `/syncgroupm` | `bot/modules/commands/syncs.py` | âœ… å·²å®Œæˆ | ä½¿ç”¨ `get_user_emby_service()` |
| `/syncunbound` | `bot/modules/commands/syncs.py` | âœ… å·²å®Œæˆ | éå†æ‰€æœ‰æœåŠ¡å™¨ |
| `/bindall_id` | `bot/modules/commands/syncs.py` | âœ… å·²å®Œæˆ | éå†æ‰€æœ‰æœåŠ¡å™¨ |
| `/embyadmin` | `bot/modules/commands/syncs.py` | âœ… å·²å®Œæˆ | ä½¿ç”¨ `get_user_emby_service()` |
| `/restore_from_db` | `bot/modules/commands/syncs.py` | âœ… å·²å®Œæˆ | ä½¿ç”¨ `get_user_emby_service()` |
| `/unbanall` | `bot/modules/commands/syncs.py` | âœ… å·²å®Œæˆ | éå†æ‰€æœ‰æœåŠ¡å™¨ |
| `/banall` | `bot/modules/commands/syncs.py` | âœ… å·²å®Œæˆ | éå†æ‰€æœ‰æœåŠ¡å™¨ |
| `/paolu` | `bot/modules/commands/syncs.py` | âœ… å·²å®Œæˆ | éå†æ‰€æœ‰æœåŠ¡å™¨ |
| `/auditip` | `bot/modules/commands/audit.py` | âœ… å·²å®Œæˆ | èšåˆæ‰€æœ‰æœåŠ¡å™¨å®¡è®¡ç»“æœ |
| `/auditdevice` | `bot/modules/commands/audit.py` | âœ… å·²å®Œæˆ | èšåˆæ‰€æœ‰æœåŠ¡å™¨å®¡è®¡ç»“æœ |
| `/auditclient` | `bot/modules/commands/audit.py` | âœ… å·²å®Œæˆ | èšåˆæ‰€æœ‰æœåŠ¡å™¨å®¡è®¡ç»“æœ |
| `/embylibs_blockall` | `bot/modules/commands/emby_libs.py` | âœ… å·²å®Œæˆ | ä½¿ç”¨ `get_user_emby_service()` |
| `/embylibs_unblockall` | `bot/modules/commands/emby_libs.py` | âœ… å·²å®Œæˆ | ä½¿ç”¨ `get_user_emby_service()` |
| `/extraembylibs_blockall` | `bot/modules/commands/emby_libs.py` | âœ… å·²å®Œæˆ | ä½¿ç”¨ `get_user_emby_service()` |
| `/extraembylibs_unblockall` | `bot/modules/commands/emby_libs.py` | âœ… å·²å®Œæˆ | ä½¿ç”¨ `get_user_emby_service()` |
| ç¦»ç¾¤åˆ é™¤ | `bot/modules/callback/leave_delemby.py` | âœ… å·²å®Œæˆ | ä½¿ç”¨ `get_user_emby_service()` |
| å†…è”æœç´¢ | `bot/modules/callback/on_inline_query.py` | âœ… å·²å®Œæˆ | åªæœç´¢ç”¨æˆ·æ‰€å±æœåŠ¡å™¨ |
| æ”¶è—åŠŸèƒ½ | `bot/modules/callback/on_inline_query.py` | âœ… å·²å®Œæˆ | ä½¿ç”¨ `get_user_emby_service()` |

---

### âœ… æ— éœ€ä¿®æ”¹

ä»¥ä¸‹å‘½ä»¤ä¸æ¶‰åŠ Emby æœåŠ¡å™¨æ“ä½œï¼Œæ— éœ€ä¿®æ”¹ï¼š

| å‘½ä»¤ | æ–‡ä»¶ | è¯´æ˜ |
|------|------|------|
| `/help` | `bot/modules/commands/help.py` | å¸®åŠ©æ–‡æ¡£ |
| `/faq` | `bot/modules/commands/help.py` | å¸¸è§é—®é¢˜ |
| `/guide` | `bot/modules/commands/help.py` | ä½¿ç”¨æŒ‡å— |
| `/score` | `bot/modules/commands/score_coins.py` | ç§¯åˆ†ç®¡ç† |
| `/coins` | `bot/modules/commands/score_coins.py` | è´§å¸ç®¡ç† |
| `/proadmin` | `bot/modules/commands/pro_rev.py` | æå‡ç®¡ç†å‘˜ |
| `/revadmin` | `bot/modules/commands/pro_rev.py` | æ’¤é”€ç®¡ç†å‘˜ |
| `/prouser` | `bot/modules/commands/pro_rev.py` | æå‡ç™½åå• |
| `/revuser` | `bot/modules/commands/pro_rev.py` | æ’¤é”€ç™½åå• |
| `/renewall` | `bot/modules/commands/renewall.py` | æ‰¹é‡ç»­æœŸï¼ˆåªæ”¹æ•°æ®åº“ï¼‰ |
| `/coinsall` | `bot/modules/commands/renewall.py` | æ‰¹é‡å‘å¸ |
| `/coinsclear` | `bot/modules/commands/renewall.py` | æ¸…ç©ºç§¯åˆ† |
| `/callall` | `bot/modules/commands/renewall.py` | ç¾¤å‘æ¶ˆæ¯ |
| `/viewrequests` | `bot/modules/commands/movie_request.py` | æŸ¥çœ‹æ±‚ç‰‡ |
| `/exportrequests` | `bot/modules/commands/movie_request.py` | å¯¼å‡ºæ±‚ç‰‡ |
| `/config` | `bot/modules/panel/config_panel.py` | é…ç½®é¢æ¿ |
| å®šæ—¶ä»»åŠ¡å‘½ä»¤ | `bot/modules/panel/sched_panel.py` | ä»»åŠ¡ç®¡ç† |
| åé¢‘é“å‘½ä»¤ | `bot/modules/extra/antichanel.py` | é¢‘é“ç®¡ç† |
| çº¢åŒ…å‘½ä»¤ | `bot/modules/extra/red_envelope.py` | çº¢åŒ…ç³»ç»Ÿ |
| `/checkin` | `bot/modules/callback/checkin.py` | ç­¾åˆ°ï¼ˆåªæ¶‰åŠæ•°æ®åº“ï¼‰ |

---

## å®æ–½å»ºè®®

### ä¿®æ”¹ä¼˜å…ˆçº§

**æ‰€æœ‰å‘½ä»¤å·²å®Œæˆå¤šæœåŠ¡å™¨é€‚é…ï¼**

| ä¼˜å…ˆçº§ | æ¨¡å— | çŠ¶æ€ |
|--------|------|------|
| P0 - æ ¸å¿ƒåŠŸèƒ½ | ç”¨æˆ·åˆ›å»ºã€ç»­æœŸã€åˆ é™¤ã€ç¦»ç¾¤åˆ é™¤ | âœ… å·²å®Œæˆ |
| P1 - æ‰¹é‡æ“ä½œ | ç¾¤ç»„åŒæ­¥ã€åª’ä½“åº“ç®¡ç† | âœ… å·²å®Œæˆ |
| P2 - æŸ¥è¯¢åŠŸèƒ½ | å®¡è®¡å‘½ä»¤ã€å†…è”æŸ¥è¯¢ | âœ… å·²å®Œæˆ |

### é€šç”¨ä¿®æ”¹æ¨¡å¼

#### æ¨¡å¼ 1: å•ç”¨æˆ·æ“ä½œ
```python
# æ ¹æ®ç”¨æˆ· TG ID è·å–å¯¹åº”æœåŠ¡
emby_service, server_config, user = get_user_emby_service(tg)
if not emby_service:
    return await sendMessage(msg, 'âŒ æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨')

# æ‰§è¡Œæ“ä½œ
result = await emby_service.some_operation(user.embyid)
```

#### æ¨¡å¼ 2: æ‰¹é‡ç”¨æˆ·æ“ä½œ
```python
# æŒ‰ç”¨æˆ·æ‰€å±æœåŠ¡å™¨åˆ†ç»„æ“ä½œ
success_count = 0
fail_count = 0

for user in users:
    emby_service, server_config, _ = get_user_emby_service(user.tg)
    if not emby_service:
        LOGGER.warning(f"è·³è¿‡ç”¨æˆ· {user.tg}: æ— æ³•å®šä½æœåŠ¡å™¨")
        fail_count += 1
        continue

    try:
        result = await emby_service.some_operation(user.embyid)
        if result:
            success_count += 1
        else:
            fail_count += 1
    except Exception as e:
        LOGGER.error(f"æ“ä½œå¤±è´¥: {e}")
        fail_count += 1

# è¿”å›ç»Ÿè®¡ç»“æœ
```

#### æ¨¡å¼ 3: å…¨æœåŠ¡å™¨æŸ¥è¯¢
```python
# æ±‡æ€»æ‰€æœ‰æœåŠ¡å™¨çš„ç»“æœ
all_results = []

for server_id, emby_service in emby_manager.get_all_servers().items():
    try:
        success, result = await emby_service.query_something()
        if success and result:
            # æ·»åŠ æœåŠ¡å™¨æ ‡è¯†
            for item in result:
                item['server_id'] = server_id
                item['server_name'] = config.get_server_by_id(server_id).name
            all_results.extend(result)
    except Exception as e:
        LOGGER.warning(f"æŸ¥è¯¢æœåŠ¡å™¨ {server_id} å¤±è´¥: {e}")

# è¿”å›æ±‡æ€»ç»“æœ
```

---

## æµ‹è¯•æ£€æŸ¥æ¸…å•

### åŠŸèƒ½æµ‹è¯•

- [ ] **ç”¨æˆ·åˆ›å»º**
  - [ ] åœ¨ä¸åŒæœåŠ¡å™¨åˆ›å»ºç”¨æˆ·
  - [ ] éªŒè¯ç”¨æˆ·è¢«æ­£ç¡®åˆ†é…åˆ°æŒ‡å®šæœåŠ¡å™¨
  - [ ] éªŒè¯ `server_id` å­—æ®µæ­£ç¡®å†™å…¥æ•°æ®åº“

- [ ] **ç”¨æˆ·ç»­æœŸ**
  - [ ] æµ‹è¯•å·²è¿‡æœŸè´¦æˆ·ç»­æœŸ
  - [ ] æµ‹è¯•æœªè¿‡æœŸè´¦æˆ·ç»­æœŸ
  - [ ] éªŒè¯æ“ä½œæ­£ç¡®çš„æœåŠ¡å™¨

- [ ] **ç”¨æˆ·åˆ é™¤**
  - [ ] é€šè¿‡ TG ID åˆ é™¤
  - [ ] é€šè¿‡ Emby ç”¨æˆ·ååˆ é™¤
  - [ ] éªŒè¯åªåˆ é™¤æŒ‡å®šæœåŠ¡å™¨çš„è´¦æˆ·

- [ ] **æ‰¹é‡æ“ä½œ**
  - [ ] ç¾¤ç»„åŒæ­¥ï¼ˆå¤šæœåŠ¡å™¨ç”¨æˆ·ï¼‰
  - [ ] æ‰¹é‡åª’ä½“åº“æ“ä½œ
  - [ ] éªŒè¯æ‰€æœ‰æœåŠ¡å™¨éƒ½è¢«æ­£ç¡®å¤„ç†

- [ ] **æŸ¥è¯¢åŠŸèƒ½**
  - [ ] IP å®¡è®¡ï¼ˆå¤šæœåŠ¡å™¨æ±‡æ€»ï¼‰
  - [ ] è®¾å¤‡å®¡è®¡ï¼ˆå¤šæœåŠ¡å™¨æ±‡æ€»ï¼‰
  - [ ] å®¢æˆ·ç«¯å®¡è®¡ï¼ˆå¤šæœåŠ¡å™¨æ±‡æ€»ï¼‰
  - [ ] å†…è”æœç´¢ï¼ˆå¤šæœåŠ¡å™¨æ±‡æ€»æˆ–æŒ‡å®šæœåŠ¡å™¨ï¼‰

- [ ] **ç”¨æˆ·ä½“éªŒ**
  - [ ] `/start` - ä¸ªäººé¢æ¿æ˜¾ç¤ºæ­£ç¡®
  - [ ] `/myinfo` - æ˜¾ç¤ºæ‰€å±æœåŠ¡å™¨ä¿¡æ¯
  - [ ] `/count` - æ˜¾ç¤ºæ­£ç¡®çš„æœåŠ¡å™¨ç»Ÿè®¡

### è¾¹ç•Œæµ‹è¯•

- [ ] ç”¨æˆ·åœ¨æ•°æ®åº“ä½† `server_id` ä¸ºç©ºï¼ˆfallback åˆ° 'main'ï¼‰
- [ ] ç”¨æˆ·çš„ `server_id` å¯¹åº”æœåŠ¡å™¨ä¸å­˜åœ¨æˆ–æœªå¯ç”¨
- [ ] æœåŠ¡å™¨è¿æ¥å¤±è´¥çš„é”™è¯¯å¤„ç†
- [ ] å¹¶å‘æ“ä½œçš„æ•°æ®ä¸€è‡´æ€§

### æ€§èƒ½æµ‹è¯•

- [ ] æ‰¹é‡æ“ä½œå¤§é‡ç”¨æˆ·çš„æ€§èƒ½
- [ ] è·¨æœåŠ¡å™¨æŸ¥è¯¢çš„å“åº”æ—¶é—´
- [ ] å¤šæœåŠ¡å™¨åŒæ—¶æ“ä½œçš„å¹¶å‘æ€§èƒ½

---

## é™„å½•

### å·²å®Œæˆä¿®æ”¹çš„æ–‡ä»¶æ¸…å•

```
bot/modules/commands/exchange.py          # âœ… P0 - ç»­æœŸ
bot/modules/commands/rmemby.py            # âœ… P0 - åˆ é™¤ç”¨æˆ·
bot/modules/callback/leave_delemby.py     # âœ… P0 - ç¦»ç¾¤åˆ é™¤
bot/modules/commands/syncs.py             # âœ… P1 - æ‰¹é‡æ“ä½œ
bot/modules/commands/emby_libs.py         # âœ… P1 - åª’ä½“åº“ç®¡ç†
bot/modules/commands/audit.py             # âœ… P2 - å®¡è®¡
bot/modules/callback/on_inline_query.py   # âœ… P2 - å†…è”æŸ¥è¯¢
```

### å¯¼å…¥è¯­å¥å‚è€ƒ

æ‰€æœ‰éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶åº”æ·»åŠ ä»¥ä¸‹å¯¼å…¥ï¼š

```python
from bot.func_helper.emby_utils import get_user_emby_service, get_server_by_id_or_none
from bot.func_helper.emby_manager import emby_manager
from bot import config, LOGGER
```

ç§»é™¤æ—§çš„å¯¼å…¥ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼š
```python
# åˆ é™¤è¿™äº›
from bot.func_helper.emby import emby
from bot import emby
```

---

**æ–‡æ¡£ç»´æŠ¤**: æœ¬æ–‡æ¡£åº”éšç€ä»£ç ä¿®æ”¹è¿›åº¦æ›´æ–°ï¼Œæ ‡è®°å·²å®Œæˆçš„é¡¹ç›®ã€‚

**ç›¸å…³æ–‡æ¡£**:
- [å¤šæœåŠ¡å™¨å¿«é€Ÿå¼€å§‹æŒ‡å—](./multi-server-quickstart.md)
- [è¿ç§»å®ŒæˆæŠ¥å‘Š](./MIGRATION_COMPLETED.md)
- [æŠ€æœ¯æ–¹æ¡ˆ](./multi-server-migration-plan.md)
